Спецификация: GLM Code Review Bot для GitLab
1. Цель

Создать бота, который автоматически анализирует изменения в merge request (MR) с помощью модели GLM‑4.6 и публикует рекомендации и комментарии прямо в MR. Бот должен быть:

Независимым от CodeRabbit;

Интегрированным в GitLab CI;

Способным обрабатывать как небольшие, так и большие изменения;

Поддерживать читаемые и структурированные комментарии по файлам.

2. Компоненты системы
Компонент	Описание	Технологии/Примеры
GitLab CI/CD pipeline	Триггер для анализа MR	.gitlab-ci.yml
Review Bot	Скрипт для запроса diff, отправки в GLM и публикации комментариев	Python 3.11+, requests
GLM API	Генерация комментариев и анализа	GLM‑4.6 от Z.ai, API ключ
CI/CD Variables	Хранение секретов	GITLAB_TOKEN, GLM_API_KEY, GITLAB_API_URL
MR Diff Parser	Преобразует изменения в формат для GLM	Python JSON/строки
Comment Publisher	Публикует результаты в MR	GitLab API /merge_requests/:id/notes
3. Workflow

Триггер:
MR создаётся или обновляется → GitLab CI запускает stage code_review.

Получение изменений:
Бот через GitLab API получает diff файлов MR.

Формирование запроса для GLM:

Конкатенация изменений по файлам;

Добавление подсказки (prompt) для анализа и рекомендаций;

Опционально: указание формата ответа (JSON/Markdown).

Отправка в GLM API:

POST-запрос с prompt;

Получение анализа и комментариев.

Публикация в MR:

Разделение комментариев по файлам и строкам (опционально);

Использование GitLab API для публикации.

Логирование:

Все запросы и ответы GLM сохраняются для отладки и аналитики.

4. Требования к переменным окружения
Переменная	Описание
GLM_API_KEY	API ключ для GLM‑4.6
GITLAB_TOKEN	Personal Access Token для публикации комментариев
GITLAB_API_URL	URL GitLab API, напр. https://gitlab.example.com/api/v4
CI_PROJECT_ID	ID проекта в GitLab (автоматически)
CI_MERGE_REQUEST_IID	ID MR (автоматически)
5. Требования к CI/CD

Stage: review

Запуск: только для merge requests (only: merge_requests)

Docker image: Python 3.11 или совместимый

Установка зависимостей: requests (или httpx для async)

Пример .gitlab-ci.yml:

stages:
  - review

code_review:
  stage: review
  image: python:3.11
  script:
    - pip install requests
    - python review_bot.py
  only:
    - merge_requests

6. Требования к скрипту review_bot.py

Получает diff через GitLab API

Формирует prompt для GLM (с инструкциями по ревью)

Отправляет diff в GLM API и получает рекомендации

Публикует комментарии в MR через GitLab API

Обрабатывает ошибки API (retry, логирование)

Поддерживает ограничение по размеру diff (разбивка на чанки)

Формат prompt для GLM:

Проанализируй этот код и предложи:
1. Улучшение читаемости
2. Исправление потенциальных багов
3. Оптимизацию функций
Формат ответа: JSON со структурой { "file": "path", "line": номер, "comment": "текст" }
Diff:
<тут diff>

7. Улучшения и расширения

Комментарии по файлам и строкам:

Можно автоматически добавлять к определённым строкам через GitLab API position в notes.

Патчи/исправления:

Генерация готовых исправлений в формате git patch.

Ограничение токенов GLM:

Разбивка больших diff на чанки (~2000–4000 токенов).

Логирование и мониторинг:

Хранение всех запросов и ответов для анализа эффективности модели.

Возможность отключать бота на отдельных проектах через CI/CD переменные.

8. Ограничения

Модель GLM может генерировать шумные или избыточные комментарии.

Не заменяет опытного ревьюера на архитектурные и дизайнерские решения.

В больших MR возможны задержки из-за ограничения по размеру запроса к GLM.
